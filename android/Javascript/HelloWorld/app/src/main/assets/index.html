<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <title>Android Webview Sample</title>
</head>

<body>
<header style="text-align: center; padding-top: 20px;">
    <h1>Android Webview</h1>
</header>
<hr>
<div class="container" style="margin-top: 300px; padding: 0 10px; text-align: center;">
    <button id="start" class="layui-btn" style="margin: 5px 0;">Start Scan</button>
    <button id="stop" class="layui-btn" style="margin: 5px 0;">Stop Scan</button>
    <hr>

    <span>Choose the Formats to Detect: </span>
    <form id="chooseBarcodeFormats">
        <input type="checkbox" id="OneD" name="barcodeFormat" value="BF_ONED">
        <label for="OneD"> 1D </label><br />
        <input type="checkbox" id="QR" name="barcodeFormat" value="BF_QR_CODE">
        <label for="QR"> QR Code </label><br />
        <input type="checkbox" id="PDF417" name="barcodeFormat" value="BF_PDF417">
        <label for="PDF417"> PDF 417 </label><br />
        <input type="checkbox" id="Datamatrix" name="barcodeFormat" value="BF_DATAMATRIX">
        <label for="Datamatrix"> DataMatrix </label> <br />
    </form>
    <span>Expected barcode count per frame: </span>
    <input type="range" min="1" max="20" step="1" id="expectedNumberBarcodes" value="1">
    <span id="expectedNumberBarcodesLable">1</span>
</div>

<script>
        class WebviewBridge {

            constructor() {
                // The following field 'Android' and these methods are specified in the relevant code of the WebView
                if (window.Android) {
                    this.methodsMap = window.Android;
                    this.setCameraUI = (list) => {
                        this.methodsMap.setCameraUI(list);
                    };
                    this.startScanning = () => {
                        this.methodsMap.startScanning();
                    };
                    this.stopScanning = () => {
                        this.methodsMap.stopScanning();
                    };
                    this.getRuntimeSettings = () => {
                        return this.methodsMap.getRuntimeSettings();
                    };
                    this.getEnumBarcodeFormat = () => {
                        return this.methodsMap.getEnumBarcodeFormat();
                    };
                    this.updateRuntimeSettings = (settings) => {
                        this.methodsMap.updateRuntimeSettings(settings);
                    };
                } else {
                    this.methodsMap = null;
                }
                // callback when the barcode results are returned
                this.onBarcodeRead = () => { };
            }

            setBarcodeReadCallback(callback) {
                this.onBarcodeRead = callback;
            }
        }

        let settings = {};
        let lastResultText = "";

        const webviewBridge = new WebviewBridge();
        
        if (!webviewBridge.methodsMap) {
            alert("Can't get 'window.Android'");
        }

        webviewBridge.setBarcodeReadCallback((result) => {
            const json = JSON.parse(result);
            console.log(json);
            if (lastResultText !== json[0].barcodeText) {
                lastResultText = json[0].barcodeText;
                alert(json[0].barcodeText);
            }
        });

        // set the position of the CameraView
        // [marginLeft, marginTop, width, height] / px
        webviewBridge.setCameraUI([75, 140, 250, 250]);

        document.getElementById("start").addEventListener("click", () => {
            webviewBridge.startScanning();
        });
        document.getElementById("stop").addEventListener("click", () => {
            webviewBridge.stopScanning();
        });

        const EnumBarcodeFormat = JSON.parse(webviewBridge.getEnumBarcodeFormat());
        chooseBarcodeFormats.onchange = () => {
            const settings = JSON.parse(webviewBridge.getRuntimeSettings());
            settings.barcodeFormatIds = EnumBarcodeFormat.BF_NULL;
            const checkboxes = document.querySelectorAll('input[name="barcodeFormat"]:checked');
            checkboxes.forEach((checkbox) => {
                switch (checkbox.value) {
                    case "BF_ONED":
                        settings.barcodeFormatIds |= EnumBarcodeFormat.BF_ONED;
                        break;
                    case "BF_QR_CODE":
                        settings.barcodeFormatIds |= EnumBarcodeFormat.BF_QR_CODE;
                        break;
                    case "BF_PDF417":
                        settings.barcodeFormatIds |= EnumBarcodeFormat.BF_PDF417;
                        break;
                    case "BF_DATAMATRIX":
                        settings.barcodeFormatIds |= EnumBarcodeFormat.BF_DATAMATRIX;
                        break;
                }
            });
            webviewBridge.updateRuntimeSettings(JSON.stringify(settings));
        }

        expectedNumberBarcodes.onchange = () => {
            let expectedVal = document.getElementById('expectedNumberBarcodes').value;
            document.getElementById('expectedNumberBarcodesLable').innerText = expectedVal;
            const settings = JSON.parse(webviewBridge.getRuntimeSettings());
            settings.expectedBarcodesCount = parseInt(expectedVal);
            webviewBridge.updateRuntimeSettings(JSON.stringify(settings));
        }

    </script>
</body>

</html>